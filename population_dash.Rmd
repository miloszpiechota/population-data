---
title: "Population Data - Spain and United Arab Emiartes"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    source_code: embed
runtime: shiny
---

```{r setup, include=FALSE}

source("population_ES_UAE.R")
library(flexdashboard)
library(googlesheets4)
#gs4_auth()
# load data in 'global' chunk so it can be shared by all users of the dashboard
library(datasets)
data(faithful)
```



DATA SET {data-icon="fa-list"}
=====================================

**Population Data** Data Set.

Column {data-width=300}
-----------------------------------------------------------------------

### Data Set Basic Information

```{r results='asis', warning=FALSE}
source("Text/DataSetBasicInformation.R", encoding = "UTF-8")
cat(gsub("\n", "<br>", text))
```

### Aims 

```{r results='asis', warning=FALSE}
source("Text/Aims.R", encoding = "UTF-8")
cat(gsub("\n", "<br>", text_aims))
```




Column {data-width=300}
-----------------------------------------------------------------------
### Data Set


```{r}
library(DT)
library(tidyverse)
library(flexdashboard)
library(ggplot2)
source("population_final.R")


additional_data %>%
  DT::datatable(rownames = FALSE, options=list(pageLength=15))
```

BMI PLOTS {data-icon="fa-list"}
=====================================



Column {data-width=300}
-----------------------------------------------------------------------
### Data
```{r}

# Załaduj wymagane pakiety
library(tidyverse)

library(ggplot2)
library(dplyr)
library(readr)

# Wczytaj dane
additional_data <- read_csv("additional_data.csv")
dane <- read_csv("BMI_real.csv")

# Przetwórz dane
obesity_trends <- additional_data %>%
  mutate(is_obese = ifelse(BMI >= 30, 1, 0)) %>%
  group_by(country, year) %>%
  summarise(obesity_rate = mean(is_obese, na.rm = TRUE) * 100, .groups = 'drop')

bmi_trend <- additional_data %>%
  group_by(country, year) %>%
  summarise(mean_BMI = mean(BMI, na.rm = TRUE), .groups = 'drop')

# Definiowanie UI
ui <- fluidPage(
  uiOutput("dynamicTitle"),  # Dynamiczny tytuł
  sidebarLayout(
    sidebarPanel(
      uiOutput("opisWykresu")  # Dynamiczny opis
    ),
    mainPanel(
      tabsetPanel(
        id = "tabs",
        tabPanel("Trend otyłości (BMI ≥ 30) symulacja", plotOutput("obesityTrend")),
        tabPanel("Trend średniego BMI w czasie symulacja", plotOutput("meanBmiTrend")),
        tabPanel("Procentowy udział kategorii BMI", plotOutput("bmiCategories")),
        tabPanel("Średnie BMI w czasie (dane WHO)", plotOutput("mean1")),
        tabPanel("BMI (WHO vs symulacja)", plotOutput("mean2")),
        tabPanel("BMI (WHO vs symulacja) - wizualizacja różnic w czasie", plotOutput("mean3")),
        tabPanel("BMI (WHO vs symulacja) - obszar różnic", plotOutput("mean3")),
        tabPanel("Średnie BMI wg krajów",
          sidebarLayout(
            sidebarPanel(
              checkboxGroupInput(
                inputId = "selected_countries",
                label = "Wybierz kraj(e):",
                choices = unique(additional_data$country),
                selected = unique(additional_data$country)
              )
            ),
            mainPanel(
              plotOutput("bmi_plot")
            )
          )
        )
      )
    )
  )
)

server <- function(input, output) {
  
  output$dynamicTitle <- renderUI({
    active_tab <- input$tabs
    
    title_text <- switch(active_tab,
      "Trend otyłości (BMI ≥ 30) symulacja" = "Trend otyłości",
      "Trend średniego BMI w czasie symulacja" = "Trend średniego BMI",
      "Procentowy udział kategorii BMI" = "Kategorie BMI",
      "Średnie BMI w czasie (dane WHO)" = "Średnie BMI (WHO)",
      "BMI (WHO vs symulacja)" = "BMI: WHO vs symulacja",
      "BMI (WHO vs symulacja) - obszar różnic" = "BMI: obszar różnic",
      "Średnie BMI wg krajów" = "Średnie BMI wg krajów",
      "Dashboard BMI i Otyłości"
    )
    
    titlePanel(title_text)
  })
  
  output$opisWykresu <- renderUI({
    active_tab <- input$tabs
    
    tekst_opisu <- switch(active_tab,
      "Trend otyłości (BMI ≥ 30) symulacja" = "Wykres przedstawia zmiany w odsetku osób z otyłością (BMI ≥ 30) w czasie. 
      
      Na podstawie symulacji można wysunąć wnioski że:
      1. UAE ma najwyższy poziom otyłości spośród wszystkich prezentowanych krajów. Widoczny trend spadkowy – odsetek osób z otyłością maleje z ponad 21% do około 16%.
      2. GB ma drugi najwyższy poziom otyłości. Również widoczny trend spadkowy, choć mniej stromy niż w przypadku UAE. 
      3.ES ma stosunkowo stabilny poziom otyłości, około 16% – brak wyraźnego trendu wzrostowego lub spadkowego.
      4.USA ma bardzo niska wartość – praktycznie zerowy odsetek osób z otyłością przez cały okres co oznacza ze dane USA nie przewiduja otylosci > 30",
      
      
      "Trend średniego BMI w czasie symulacja" = "Wykres pokazuje trend średniego BMI dla wybranych krajów na przestrzeni lat. Wykres bazuje na regresji liniowej – pokazuje ogólny trend (wzrostowy lub spadkowy).
      UAE (Zjednoczone Emiraty Arabskie) zaczynają z bardzo wysokim średnim BMI (~25.9), ale trend wyraźnie spada.

GB (Wielka Brytania) również zaczyna z wysokiego poziomu, choć nieco wyżej niż UAE, i także notuje spadek.
US (Stany Zjednoczone) jako jedyny kraj notuje stały wzrost BMI
",
      "Procentowy udział kategorii BMI" = "Wizualizacja udziału poszczególnych kategorii BMI (np. otyłość, niedowaga) w każdym kraju. Dla TJK Aż 90% populacji ma prawidłowe BMI. Brak nadwagi i otyłości – idealna sytuacja zdrowotna. ",
      "Średnie BMI w czasie (dane WHO)" = "Trend średniego BMI wg danych rzeczywistych (WHO) dla wybranych krajów. Symulacja znacznie zaniża rzeczywiste wartości BMI we wszystkich krajach (szczególnie w krajach rozwiniętych). ",
      "BMI (WHO vs symulacja)" = "Porównanie trendów średniego BMI: dane WHO (rzeczywiste) vs dane sztuczne. Jak bardzo i w którą stronę symulacja odbiega od rzeczywistości.
      Hiszpania:
Różnica rośnie do ~2010 (ok. +9 punktów), potem lekki spadek.

Model coraz bardziej niedoszacowuje rzeczywistość, ale po 2010 trend się stabilizuje.

Tadżykistan:
Różnica ujemna przez cały czas (~–3), czyli model przewiduje wyższe BMI niż rzeczywistość.

Stabilność – brak dużych błędów predykcji.

USA:
Różnica bardzo duża (ok. +18 punktów), stabilizuje się po 2010.

Model znacznie zaniża rzeczywiste BMI.

Wielka Brytania:
Różnica rośnie do ok. +6 i utrzymuje się.

Model niedoszacowuje wzrostu BMI w UK.

Zjednoczone Emiraty Arabskie:
Różnica rośnie bardzo wyraźnie, do ponad +20 w 2020.

Model drastycznie niedoszacowuje rzeczywistego wzrostu BMI.",
      
      "BMI (WHO vs symulacja) - obszar różnic" = "Wizualizacja różnic między BMI rzeczywistym i sztucznym – obszar różnicy (ribbon plot).Im większy niebieski obszar, tym większa różnica między BMI rzeczywistym a symulowanym.

Jeśli czerwona linia leży powyżej zielonej, to model zaniża BMI.

Jeśli zielona leży wyżej – model zawyża rzeczywistość (co tu prawie nie występuje).

Różnica może narastać, maleć, lub być stała w czasie.

",
      "Średnie BMI wg krajów" = "Interaktywny wykres pokazujący zmiany średniego BMI na przestrzeni lat dla wybranych krajów.Punkty pokazują rozrzut (wariancję) wartości w czasie. Czerwona linia to linia trendu (gładka krzywa) utworzona za pomocą funkcji geom_smooth() z ggplot2",
      "Wybierz wykres po lewej, aby zobaczyć opis."
    )
    
    HTML(paste("<b>Opis wykresu:</b><br>", tekst_opisu))
  })



  
output$obesityTrend <- renderPlot({
  library(dplyr)
  library(ggplot2)

  ggplot(obesity_trends, aes(x = year, y = obesity_rate, color = country)) +
    geom_smooth(se = FALSE, method = "loess", span = 0.4, size = 1.2) +
    scale_y_continuous(labels = function(x) paste0(x, "%")) +
    scale_x_continuous(
      breaks = seq(min(obesity_trends$year), max(obesity_trends$year), 25),
      limits = c(min(obesity_trends$year), max(obesity_trends$year) + 10)
    ) +
    labs(
      title = "Trend otyłości (BMI ≥ 30) w czasie",
      subtitle = "Odsetek osób z otyłością w wybranych krajach (1925–2025)",
      x = "Rok",
      y = "Odsetek osób z otyłością [%]",
      color = "Kraj",  # nazwa legendy
      caption = "Źródło: dane symulowane na podstawie modelu edukacyjno-demograficznego"
    ) +
    theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(face = "bold"),
      plot.caption = element_text(size = 10, face = "italic", hjust = 1),
      legend.position = "right"  # <- pokazuje legendę
    )
})




  

  
  #  Wykres 2: Trend średniego BMI w czasie  – regresja liniowa (symulacja)

  output$meanBmiTrend <- renderPlot({
    ggplot(bmi_trend, aes(x = year, y = mean_BMI, color = country)) +
      geom_smooth(method = "lm", se = FALSE, size = 1.3) +
      labs(
        title = "Trend średniego BMI w czasie",
        subtitle = "Dane dla wybranych krajów (1925–2025)",
        x = "Rok",
        y = "Średni BMI",
        color = "Kraj"
      ) +
      theme_minimal()
  })
  
  

library(tidyverse)
library(readr)

# === Wczytanie danych ===

# 1. WHO BMI data (BMI_real.csv)
dane_real <- read_csv("BMI_real.csv")

# 2. Sztuczne dane BMI (additional_data.csv) — cały w jednej kolumnie
dane_additional_raw <- read_delim("additional_data.csv", delim = "\t", col_names = FALSE)

# Rozdzielenie kolumn z pliku dodatkowego
dane_additional <- dane_additional_raw %>%
  separate(X1, into = c("id1", "id2", "id3", "year", "col5", "citizenship", "BMI", "col8", "col9"),
           sep = "\t|,", extra = "merge", fill = "right") %>%
  mutate(
    BMI = str_replace(BMI, ",", "."),
    BMI = as.numeric(BMI),
    year = as.numeric(year)
  )

# === Mapowanie kodów krajów ===
country_code_mapping <- tibble(
  code_real = c("ESP", "GBR", "TJK", "USA", "ARE"),
  code_additional = c("ES", "GB", "TJK", "US", "UAE"),
  country_name = c("Hiszpania", "Wielka Brytania", "Tadżykistan", "USA", "Zjednoczone Emiraty Arabskie")
)

# === Oczyszczanie danych WHO ===
dane_real_filtered <- dane_real %>%
  filter(SpatialDimensionValueCode %in% country_code_mapping$code_real) %>%
  mutate(
    year = as.numeric(TimeDim),
    BMI_real = as.numeric(NumericValue)
  ) %>%
  left_join(country_code_mapping, by = c("SpatialDimensionValueCode" = "code_real")) %>%
  select(country_name, year, BMI_real) %>%
  filter(!is.na(country_name), !is.na(BMI_real), !is.na(year))

# === Oczyszczanie danych sztucznych ===
dane_additional_filtered <- dane_additional %>%
  filter(citizenship %in% country_code_mapping$code_additional) %>%
  left_join(country_code_mapping, by = c("citizenship" = "code_additional")) %>%
  group_by(country_name, year) %>%
  summarise(BMI_additional = mean(BMI, na.rm = TRUE), .groups = "drop") %>%
  filter(!is.na(country_name), !is.na(BMI_additional), !is.na(year))

# === Połączenie danych ===
dane_combined <- dane_real_filtered %>%
  inner_join(dane_additional_filtered, by = c("country_name", "year")) %>%
  mutate(difference = BMI_real - BMI_additional)


output$mean2 <- renderPlot({
  # 2. Różnica w średnim BMI — z gładką linią
  ggplot(dane_combined, aes(x = year, y = difference)) +
  geom_smooth(color = "purple", method = "loess", size = 1.2) +
  facet_wrap(~ country_name) +
  labs(
    title = "Różnica w średnim BMI w czasie",
    x = "Rok",
    y = "Różnica BMI (Rzeczywiste - Sztuczne)"
  ) +
  theme_minimal()
})

output$mean3 <-renderPlot({
  # 3. Obszar różnicy (ribbon) — z gładką linią
ggplot(dane_combined, aes(x = year)) +
  geom_ribbon(aes(ymin = pmin(BMI_real, BMI_additional), ymax = pmax(BMI_real, BMI_additional)),
              fill = "blue", alpha = 0.3) +
  geom_smooth(aes(y = BMI_real), method = "loess", color = "red", size = 1.2) +
  geom_smooth(aes(y = BMI_additional), method = "loess", color = "green", size = 1.2, linetype = "dashed") +
  facet_wrap(~ country_name) +
  labs(
    title = "Obszar różnicy między średnim BMI",
    x = "Rok",
    y = "BMI"
  ) +
  theme_minimal()
})
  # Wykres 5: Porównanie trendów średniego BMI (WHO vs symulacja)

  output$mean1 <- renderPlot({
      # 1. Porównanie trendów BMI — z gładkimi liniami
ggplot(dane_combined, aes(x = year)) +
  geom_smooth(aes(y = BMI_real, color = "WHO"), method = "loess", size = 1.2) +
  geom_smooth(aes(y = BMI_additional, color = "symulacja"), method = "loess", size = 1.2, linetype = "dashed") +
  facet_wrap(~ country_name) +
  labs(
    title = "Porównanie trendów średniego BMI (WHO vs symulacja)",
    x = "Rok",
    y = "Średnie BMI",
    color = "Źródło danych"
  ) +
  theme_minimal()
  })
  

  
  
  #Wykres 4: Średnie BMI w czasie (dane WHO) – REALNE wartości

  output$meanBmiReal <- renderPlot({
    

# 1. Wczytanie danych
dane <- read_csv("BMI_real.csv")  # <- zamień na prawdziwą nazwę pliku

# 2. Filtrowanie i przygotowanie danych tylko dla wybranych krajów
kraje_docelowe <- c("ESP", "GBR", "TJK", "USA", "ARE")

bmi_trend <- dane %>%
  filter(
    SpatialDimensionValueCode %in% kraje_docelowe,
    !is.na(NumericValue),
    !is.na(TimeDim)
  ) %>%
  mutate(
    rok = as.numeric(TimeDim),
    kraj = case_when(
      SpatialDimensionValueCode == "ESP" ~ "Hiszpania",
      SpatialDimensionValueCode == "GBR" ~ "Wielka Brytania",
      SpatialDimensionValueCode == "TJK" ~ "Tadżykistan",
      SpatialDimensionValueCode == "USA" ~ "USA",
      SpatialDimensionValueCode == "ARE" ~ "United Arab Emirates",
      TRUE ~ SpatialDimensionValueCode
    ),
    BMI = as.numeric(NumericValue)
  ) %>%
  group_by(kraj, rok) %>%
  summarise(mean_BMI = mean(BMI, na.rm = TRUE), .groups = 'drop')

# 3. Tworzenie wykresu trendu BMI
ggplot(bmi_trend, aes(x = rok, y = mean_BMI, color = kraj)) +
  geom_smooth(method = "lm", se = FALSE, linewidth = 1.3) +
  labs(
    title = "Średnie BMI w czasie (dane WHO)",
    subtitle = "Dla wybranych krajów: ESP, GB, TJK, USA, ARE",
    x = "Rok",
    y = "Średni BMI",
    color = "Kraj"
  ) +
  theme_minimal()

  })
  


# Wczytaj dane
additional_data <- read_csv("additional_data.csv")
# Dodaj kolumnę z kategorią BMI
additional_data <- additional_data %>%
  mutate(BMI_category = case_when(
    BMI < 18.5 ~ "Niedowaga",
    BMI >= 18.5 & BMI < 25 ~ "Prawidłowa",
    BMI >= 25 & BMI < 30 ~ "Nadwaga",
    BMI >= 30 ~ "Otyłość"
  ))

# Dodaj ten fragment DO TWOJEGO ISTNIEJĄCEGO SERVERA

output$bmi_plot <- renderPlot({
  filtered_data <- additional_data %>%
    filter(country %in% input$selected_countries) %>%
    group_by(country, year) %>%
    summarise(avg_BMI = mean(BMI, na.rm = TRUE), .groups = "drop")

  ggplot(filtered_data, aes(x = year, y = avg_BMI, color = country)) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = -Inf, ymax = 18.5, fill = "lightblue", alpha = 0.1) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 18.5, ymax = 25, fill = "lightgreen", alpha = 0.1) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 25, ymax = 30, fill = "khaki", alpha = 0.1) +
  annotate("rect", xmin = -Inf, xmax = Inf, ymin = 30, ymax = Inf, fill = "lightcoral", alpha = 0.1) +
  geom_point(alpha = 0.5) +
  geom_smooth(se = FALSE, size = 1.3, method = "loess") +
  scale_color_brewer(palette = "Set1") +
  labs(
    title = "Średnie BMI w czasie dla wybranych krajów",
    subtitle = "Kolory reprezentują kraje. Tło pokazuje klasyfikację BMI.",
    x = "Rok",
    y = "Średnie BMI",
    color = "Kraj"
  ) +
  theme_minimal(base_size = 14)

})




  # Wykres 3: Procentowy udział poszczególnych kategorii BMI w populacji każdego kraju symulacja

  output$bmiCategories <- renderPlot({
    bmi_counts <- additional_data %>%
      mutate(BMI_category = case_when(
        BMI < 18.5 ~ "Niedowaga BMI < 18.5",
        BMI >= 18.5 & BMI < 25 ~ "Prawidłowa BMI 18.5–24.9",
        BMI >= 25 & BMI < 30 ~ "Nadwaga BMI 25–29.9",
        BMI >= 30 ~ "Otyłość BMI ≥ 30"
      )) %>%
      group_by(country, BMI_category) %>%
      summarise(count = n(), .groups = 'drop')
    
    bmi_percentages <- bmi_counts %>%
      group_by(country) %>%
      mutate(
        percentage = count / sum(count) * 100,
        label = paste0(round(percentage, 1), "%")
      ) %>%
      ungroup()
    
    ggplot(bmi_percentages, aes(x = country, y = percentage, fill = BMI_category)) +
      geom_bar(stat = "identity", position = "stack") +
      geom_text(aes(label = label), position = position_stack(vjust = 0.5), color = "black", size = 3) +
      labs(
        title = "Procentowy udział kategorii BMI w populacji każdego kraju",
        x = "Kraj",
        y = "Procent populacji",
        fill = "Kategoria BMI"
      ) +
      theme_minimal()
  })
}

# Uruchomienie aplikacji
shinyApp(ui = ui, server = server)



```




UAE PLOT{data-icon="fa-list"} =====================================
###Data
=======


UAE PLOT{data-icon="fa-list"}
=====================================


Sidebar {.sidebar}
-----------------------------------------------------------------------
```{r}
selectInput("selected_plot", "Choose a plot:",
            choices = names(plots_list),
            selected = names(plots_list)[1])
```
Column {data-width=300}
-----------------------------------------------------------------------
```{r}
plotOutput("plot")
output$plot <- renderPlot({
  req(input$selected_plot)
  plots_list[[input$selected_plot]]()
})
```
------------------------------------------------------

